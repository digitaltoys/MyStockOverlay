# 개발노트 (DEVNOTES) - 2026-02-27

## 기준가(종가) 산출 로직 단순화

### 배경
기존에는 KIS API나 Yahoo API에서 기준가 필드가 비어있거나 불확실할 경우를 대비해 현재가와 대비금액을 이용하여 수동으로 계산하는 로직(`basePrice = currentPrice - diffAmt` 등)이 포함되어 있었습니다. 하지만 이는 특정 상황(상하한가, 권리락 등)에서 오차를 발생시킬 수 있고 코드가 복잡해지는 단점이 있어, API가 제공하는 공식 종가 필드를 직접 사용하도록 설계를 단순화하였습니다.

### 주요 변경 사항
1.  **KIS 실시간/모의투자 API (`kisApi.ts`, `kisVirtualApi.ts`)**
    *   주식: `stck_sdpr` (전일 종가) 사용
    *   지수: `bstp_nmix_prdy_clpr` (전일 지수 종가) 사용
    *   수동 폴백 계산 로직 제거

2.  **Yahoo Finance 폴백 API (`fallbackApi.ts`)**
    *   `meta.chartPreviousClose` 또는 `meta.previousClose` 필드 사용
    *   기준가 부재 시 `currentPrice`로 대체하던 로직 제거 (데이터 정확성 확보)

### 효과
- 코드 가독성 향상 및 유지보수 비용 감소
- API 명세에 충실한 데이터 활용으로 계산 오차 가능성 차단
- 로직 단순화로 인한 런타임 안정성 강화

## 지수 차트 복구 및 캐싱 도입 (2026-02-27)

### 배경
- 코스피 등 업종 지수 차트가 특정 시간대 이후 표시되지 않거나 갱신이 느린 문제 해결 필요
- KIS 지수 차트 API는 페이지네이션을 지원하지 않아 한 번에 최대 30분(최신 데이터)만 가져올 수 있는 한계 존재

### 주요 변경 사항
1.  **지수 데이터 캐싱 적용**
    *   기본 주식 차트와 동일하게 `ChartCacheManager.saveMergedItems`를 사용하여 지수 데이터도 로컬 스토리지에 누적
    *   사용자가 앱을 켜두는 동안 매 30초마다 새로운 30분치 데이터를 가져와 기존 데이터와 병합하므로 전체 장일 데이터가 확보됨
2.  **데이터 범위 확장**
    *   기존 `09:00 ~ 15:30`으로 제한되었던 데이터 수집 범위를 `08:00 ~ 18:00`으로 확장하여 장 전/후 시황 확인 가능
3.  **정밀도 유지**
    *   5분봉 대신 1분봉(`FID_HOUR_CLS_CODE=1`)을 유지하여 리샘플링(`resampleTo10Minutes`) 시에도 부드러운 그래프 유지

### 효과
- 지수 데이터가 휘발되지 않고 로컬에 쌓여 긴 그래프를 렌더링 가능
- 장 마감 후에도 캐시된 데이터를 통해 당일 지수 흐름 확인 가능
